name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ— Setup repo
      uses: actions/checkout@v3

    - name: ğŸ— Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 18.x
        cache: 'npm'

    - name: ğŸ— Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: ğŸ“¦ Install dependencies
      run: pnpm install

    - name: ğŸ§¹ Lint code
      run: pnpm lint

    - name: ğŸ” Type check
      run: pnpm type-check

    - name: ğŸ§ª Run tests
      run: pnpm test

  build-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    needs: test
    
    steps:
    - name: ğŸ— Setup repo
      uses: actions/checkout@v3

    - name: ğŸ— Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 18.x
        cache: 'npm'

    - name: ğŸ— Setup pnpm  
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: ğŸ— Setup EAS
      uses: expo/expo-github-action@v8
      with:
        expo-version: latest
        eas-version: latest
        token: ${{ secrets.EXPO_TOKEN }}

    - name: ğŸ“¦ Install dependencies
      run: pnpm install

    - name: ğŸš€ Build preview
      run: eas build --profile preview --platform all --non-interactive

  build-production:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: test
    
    steps:
    - name: ğŸ— Setup repo
      uses: actions/checkout@v3

    - name: ğŸ— Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 18.x
        cache: 'npm'

    - name: ğŸ— Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: ğŸ— Setup EAS
      uses: expo/expo-github-action@v8
      with:
        expo-version: latest
        eas-version: latest
        token: ${{ secrets.EXPO_TOKEN }}

    - name: ğŸ“¦ Install dependencies
      run: pnpm install

    - name: ğŸš€ Build production
      run: eas build --profile production --platform all --non-interactive

    - name: ğŸ“± Submit to stores
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        eas submit --platform ios --non-interactive
        eas submit --platform android --non-interactive
      env:
        EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
        EXPO_ASC_APP_ID: ${{ secrets.EXPO_ASC_APP_ID }}
        EXPO_APPLE_TEAM_ID: ${{ secrets.EXPO_APPLE_TEAM_ID }}