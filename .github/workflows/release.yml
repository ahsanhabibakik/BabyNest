name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🏗 Setup repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: 📝 Generate changelog
      id: changelog
      uses: mikepenz/release-changelog-builder-action@v3
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 🚀 Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: BabyNest ${{ github.ref_name }}
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: false

  build-and-submit:
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
    - name: 🏗 Setup repo
      uses: actions/checkout@v3

    - name: 🏗 Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 18.x
        cache: 'npm'

    - name: 🏗 Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: 🏗 Setup EAS
      uses: expo/expo-github-action@v8
      with:
        expo-version: latest
        eas-version: latest
        token: ${{ secrets.EXPO_TOKEN }}

    - name: 📦 Install dependencies
      run: pnpm install

    - name: 🚀 Build for production
      run: eas build --profile production --platform all --non-interactive

    - name: 📱 Submit to App Store
      run: eas submit --platform ios --non-interactive
      env:
        EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
        EXPO_ASC_APP_ID: ${{ secrets.EXPO_ASC_APP_ID }}
        EXPO_APPLE_TEAM_ID: ${{ secrets.EXPO_APPLE_TEAM_ID }}

    - name: 🤖 Submit to Google Play
      run: eas submit --platform android --non-interactive
      env:
        EXPO_ANDROID_KEYSTORE_PATH: ${{ secrets.EXPO_ANDROID_KEYSTORE_PATH }}
        EXPO_ANDROID_KEYSTORE_PASSWORD: ${{ secrets.EXPO_ANDROID_KEYSTORE_PASSWORD }}
        EXPO_ANDROID_KEY_ALIAS: ${{ secrets.EXPO_ANDROID_KEY_ALIAS }}
        EXPO_ANDROID_KEY_PASSWORD: ${{ secrets.EXPO_ANDROID_KEY_PASSWORD }}